--Crear la base de datos
CREATE DATABASE doomProject;

--TABLA: Usuario

CREATE TABLE Usuario (
    id_usuario      SERIAL PRIMARY KEY,
    Nombre_usuario  VARCHAR(100) NOT NULL,
    Fecha_registro  DATE NOT NULL,
    Carrera         VARCHAR(100) NOT NULL
);

--TABLA: Jugador

CREATE TABLE Jugador (
    id_jugador  SERIAL PRIMARY KEY,
    id_usuario  INT NOT NULL UNIQUE,
    Nombre      VARCHAR(100) NOT NULL UNIQUE,
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id_usuario)
);

--TABLA: Episodio

CREATE TABLE Episodio (
    id_episodio SERIAL PRIMARY KEY,
    Nombre      VARCHAR(100) NOT NULL,
    Descripcion VARCHAR(255)
);

--TABLA: Mapa

CREATE TABLE Mapa (
    id_mapa     SERIAL PRIMARY KEY,
    Nombre      VARCHAR(100) NOT NULL UNIQUE,
    id_episodio INT NOT NULL,
    FOREIGN KEY (id_episodio) REFERENCES Episodio(id_episodio)
);

--TABLA: Sector

CREATE TABLE Sector (
    id_mapa   INT NOT NULL,
    columna   INT NOT NULL,
    fila      INT NOT NULL,
    geometria VARCHAR(30) NOT NULL,
    cuenta    INT NOT NULL,
    PRIMARY KEY (id_mapa, columna, fila),
    FOREIGN KEY (id_mapa) REFERENCES Mapa(id_mapa)
);

--TABLA: Partida

CREATE TABLE Partida (
    id_partida SERIAL PRIMARY KEY,
    id_jugador INT NOT NULL,
    id_mapa    INT NOT NULL,
    Hora_Inicio TIMESTAMP NOT NULL,
    Hora_Fin    TIMESTAMP NOT NULL,
    FOREIGN KEY (id_jugador) REFERENCES Jugador(id_jugador),
    FOREIGN KEY (id_mapa) REFERENCES Mapa(id_mapa)
);

--TABLA: Telemetria

CREATE TABLE Telemetria (
    id_partida INT NOT NULL,
    tiempo     TIMESTAMP NOT NULL,
    tic        INT NOT NULL,
    pos_x      INT NOT NULL,
    pos_y      INT NOT NULL,
    pos_z      INT NOT NULL,
    angulo     FLOAT NOT NULL,
    momento_x  INT NOT NULL,
    momento_y  INT NOT NULL,
    PRIMARY KEY (id_partida, Tiempo),
    FOREIGN KEY (id_partida) REFERENCES Partida(id_partida)
);

--TABLA: UXCuestionario

CREATE TABLE UXCuestionario (
    Nombre_cuestionario VARCHAR(100) PRIMARY KEY,
    numero_preguntas    INT NOT NULL
);

--TABLA: Pregunta

CREATE TABLE Pregunta (
    id_pregunta         SERIAL PRIMARY KEY,
    Nombre_cuestionario VARCHAR(100) NOT NULL,
    pregunta            VARCHAR(255) NOT NULL UNIQUE,
    calificacion_max    INT NOT NULL,
    calificacion_min    INT NOT NULL,
    FOREIGN KEY (Nombre_cuestionario) REFERENCES UXCuestonario(Nombre_cuestionario)
);

--TABLA: Responde 

CREATE TABLE Responde (
    id_pregunta     INT NOT NULL,
    id_usuario      INT NOT NULL,
    Calificacion    INT NOT NULL,
    PRIMARY KEY (id_pregunta, id_usuario),
    FOREIGN KEY (id_pregunta) REFERENCES Pregunta(id_pregunta),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id_usuario)
);

--FUNCIÓN: Validar calificación

CREATE OR REPLACE FUNCTION validar_calificacion()
RETURNS TRIGGER AS $$
DECLARE
    min_val INT;
    max_val INT;
BEGIN
    --Obtener los valores min y max de la pregunta correspondiente
    SELECT calificacion_min, calificacion_max
    INTO min_val, max_val
    FROM Pregunta
    WHERE id_pregunta = NEW.id_pregunta;

    --Si la pregunta no existe
    IF NOT FOUND THEN
        RAISE EXCEPTION 'La pregunta con id % no existe.', NEW.id_pregunta;
    END IF;

    --Validar rango permitido
    IF NEW.Calificacion < min_val OR NEW.Calificacion > max_val THEN
        RAISE EXCEPTION 'La calificación % está fuera del rango permitido [% - %].',
            NEW.Calificacion, min_val, max_val;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

--TRIGGER: Ejecuta la validación antes de insertar o actualizar

CREATE TRIGGER trg_validar_calificacion
BEFORE INSERT OR UPDATE ON Responde
FOR EACH ROW
EXECUTE FUNCTION validar_calificacion();

--Poblar tablas

--Insertar a Cuestionario
INSERT INTO UXCuestionario (Nombre_cuestionario, numero_preguntas)
VALUES ('GUESS', 18);

--Insertar a preguntas
INSERT INTO Pregunta (id_pregunta, Nombre_cuestionario, pregunta, calificacion_max, calificacion_min) VALUES
(1, 'GUESS', 'I find the controls of the game to be straightforward.', 7, 1),
(2, 'GUESS', 'I find the game''s interface to be easy to navigate.', 7, 1),
(3, 'GUESS', 'I am captivated by the game''s story from the beginning.', 7, 1),
(4, 'GUESS', 'I enjoy the fantasy or story provided by the game.', 7, 1),
(5, 'GUESS', 'I feel detached from the outside world while playing the game.', 7, 1),
(6, 'GUESS', 'I do not care to check events that are happening in the real world during the game.', 7, 1),
(7, 'GUESS', 'I think the game is fun.', 7, 1),
(8, 'GUESS', 'I feel bored while playing the game.', 7, 1),
(9, 'GUESS', 'I feel the game allows me to be imaginative.', 7, 1),
(10, 'GUESS', 'I feel creative while playing the game.', 7, 1),
(11, 'GUESS', 'I enjoy the sound effects in the game.', 7, 1),
(12, 'GUESS', 'I feel the game''s audio (e.g., sound effects, music) enhances my gaming experience.', 7, 1),
(13, 'GUESS', 'I am very focused on my own performance while playing the game.', 7, 1),
(14, 'GUESS', 'I want to do as well as possible during the game.', 7, 1),
(15, 'GUESS', 'I find the game supports social interaction (e.g., chat) between players.', 7, 1),
(16, 'GUESS', 'I like to play this game with other players.', 7, 1),
(17, 'GUESS', 'I enjoy the game''s graphics.', 7, 1),
(18, 'GUESS', 'I think the game is visually appealing.', 7, 1);

--Insertar a Usuarios
INSERT INTO Usuario (id_usuario, Nombre_usuario, Fecha_registro, Carrera) VALUES
(1, 'EstebanChaustre','2025-11-06', 'IngSistemas'),
(2, 'SamuelBorras','2025-11-06', 'IngSistemas'),
(3, 'DanielPrieto','2025-11-06', 'IngSistemas'),
(4, 'JulioTriana','2025-11-07', 'Negocios'),
(5, 'JuanMateus','2025-11-07', 'Administracion'),
(6, 'AlejandraPerdomo','2025-11-08', 'DisenoIndustrial');

--Insertar a Jugadores
INSERT INTO Jugador (id_jugador, id_usuario, Nombre) VALUES
(123, 1, 'EstebiPRO'),
(456, 2, 'Borrium'),
(789, 3, 'Danidih'),
(444, 4, 'Jeelian'),
(100, 5, 'Juanmatro'),
(126, 6, 'Alepero');

--Insertar respuestas
INSERT INTO Responde (id_pregunta, id_usuario, Calificacion) VALUES
(1, 1, 6),
(2, 1, 7),
(3, 1, 5),
(4, 1, 7),
(5, 1, 6),
(6, 1, 7),
(7, 1, 4),
(8, 1, 5),
(9, 1, 7),
(10, 1, 7),
(11, 1, 7),
(12, 1, 6),
(13, 1, 6),
(14, 1, 5),
(15, 1, 4),
(16, 1, 7),
(17, 1, 7),
(18, 1, 6),
(1, 2, 7),
(2, 2, 7),
(3, 2, 7),
(4, 2, 6),
(5, 2, 5),
(6, 2, 3),
(7, 2, 5),
(8, 2, 6),
(9, 2, 6),
(10, 2, 7),
(11, 2, 7),
(12, 2, 6),
(13, 2, 7),
(14, 2, 5),
(15, 2, 6),
(16, 2, 5),
(17, 2, 6),
(18, 2, 7),
(1, 3, 6),
(2, 3, 6),
(3, 3, 5),
(4, 3, 7),
(5, 3, 7),
(6, 3, 7),
(7, 3, 7),
(8, 3, 6),
(9, 3, 4),
(10, 3, 6),
(11, 3, 6),
(12, 3, 6),
(13, 3, 6),
(14, 3, 5),
(15, 3, 7),
(16, 3, 7),
(17, 3, 6),
(18, 3, 6),
(1, 4, 7),
(2, 4, 7),
(3, 4, 7),
(4, 4, 6),
(5, 4, 5),
(6, 4, 5),
(7, 4, 7),
(8, 4, 6),
(9, 4, 6),
(10, 4, 6),
(11, 4, 7),
(12, 4, 5),
(13, 4, 6),
(14, 4, 7),
(15, 4, 7),
(16, 4, 6),
(17, 4, 5),
(18, 4, 7),
(1, 5, 4),
(2, 5, 3),
(3, 5, 5),
(4, 5, 6),
(5, 5, 7),
(6, 5, 5),
(7, 5, 5),
(8, 5, 5),
(9, 5, 6),
(10, 5, 4),
(11, 5, 6),
(12, 5, 5),
(13, 5, 5),
(14, 5, 6),
(15, 5, 7),
(16, 5, 4),
(17, 5, 5),
(18, 5, 6),
(1, 6, 7),
(2, 6, 7),
(3, 6, 7),
(4, 6, 7),
(5, 6, 6),
(6, 6, 6),
(7, 6, 7),
(8, 6, 6),
(9, 6, 7),
(10, 6, 5),
(11, 6, 7),
(12, 6, 6),
(13, 6, 6),
(14, 6, 6),
(15, 6, 7),
(16, 6, 7),
(17, 6, 6),
(18, 6, 6);

--Isertar epsiodio
INSERT INTO Episodio (id_episodio, Nombre, Descripcion) VALUES
(1, 'Knee-Deep in the Dead', 'En la base UAC de Phobos, una falla en experimentos teletransportadores desata hordas demoníacas. Eres el único marine que debe sobrevivir y detener la invasión del Infierno');

--Insertar mapas
INSERT INTO Mapa (id_mapa, Nombre, id_episodio) VALUES 
(3,'Toxin Refinery', 1),
(5, 'Phobos Lab', 1),
(7, 'Computer Station', 1);

--Insertar a partida 
INSERT INTO Partida (id_partida, id_jugador, id_mapa, Hora_inicio, Hora_fin) values
(1, 456, 5, '2025-11-08 01:37:41', '2025-11-08 03:05:11'),
(2, 126, 3, '2025-11-08 14:32:13', '2025-11-08 14:47:52'),
(3, 100, 3, '2025-11-08 16:12:20', '2025-11-08 16:24:11'),
(4, 123, 7, '2025-11-08 16:52:42' ,'2025-11-08 18:46:28'),
(5, 444, 5, '2025-11-08 19:10:40', '2025-11-08 20:25:40'),
(6, 789, 7, '2025-11-08 21:03:55', '2025-11-08 22:35:08');

--Insertar telemetria
INSERT INTO Telemetria (id_partida, tiempo, tic, pos_x, pos_y, pos_z, angulo, momento_x,momento_y) values


